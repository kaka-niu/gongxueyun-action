name: 工学云自动签到

on:
  # 手动触发
  workflow_dispatch:
    inputs:
      mode:
        description: '打卡模式'
        required: true
        default: 'manual'
        type: choice
        options:
        - manual
        - morning
        - evening
  
  # 定时任务 - 早上7点执行上班卡
  schedule:
    - cron: '0 23 * * *'  # UTC时间23点，对应北京时间7点
  
  # 定时任务 - 下午17点执行下班卡
    - cron: '0 9 * * *'   # UTC时间9点，对应北京时间17点

jobs:
  check-in:
    runs-on: ubuntu-latest
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v3
    
    - name: 设置Python环境
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: 安装依赖
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: 判断打卡模式并执行
      env:
        USERS: ${{ secrets.USERS }}
      run: |
        # 获取当前UTC小时
        CURRENT_HOUR=$(date -u +%H)
        echo "当前UTC时间: $CURRENT_HOUR 点"
        
        # 根据时间设置模式
        if [ "$CURRENT_HOUR" = "23" ]; then
          echo "执行早上打卡（上班卡）"
          MODE=morning
        elif [ "$CURRENT_HOUR" = "09" ]; then
          echo "执行下午打卡（下班卡）"
          MODE=evening
        else
          echo "手动模式执行"
          MODE=manual
        fi
        
        # 执行打卡
        python auto.py