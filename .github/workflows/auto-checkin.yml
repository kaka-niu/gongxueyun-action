name: 工学云自动签到

on:
  # 手动触发
  workflow_dispatch:
    inputs:
      mode:
        description: '打卡模式'
        required: true
        default: 'manual'
        type: choice
        options:
        - manual
        - morning
        - evening
  
  # 定时任务 - 早上7点执行上班卡
  schedule:
    - cron: '0 23 * * *'  # UTC时间23点，对应北京时间7点
  
  # 定时任务 - 下午17点执行下班卡
    - cron: '0 9 * * *'   # UTC时间9点，对应北京时间17点

jobs:
  check-in:
    runs-on: ubuntu-latest
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v3
    
    - name: 设置Python环境
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: 安装依赖
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: 判断打卡模式并执行
      env:
        USERS: ${{ secrets.USERS }}
      run: |
        # 获取当前UTC小时
        CURRENT_HOUR=$(date -u +%H)
        echo "当前UTC时间: $CURRENT_HOUR 点"
        
        # 获取北京时间（UTC+8）的小时和星期
        BEIJING_HOUR=$(TZ='Asia/Shanghai' date +%H)
        BEIJING_WEEKDAY=$(TZ='Asia/Shanghai' date +%u)  # 1-7，1代表周一
        BEIJING_DAY_NAME=$(TZ='Asia/Shanghai' date +%A)
        echo "当前北京时间: $BEIJING_HOUR 点，星期$BEIJING_WEEKDAY ($BEIJING_DAY_NAME)"
        
        # 判断是否为手动触发
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          # 手动触发时使用用户选择的模式
          echo "手动触发模式: ${{ github.event.inputs.mode }}"
          export MODE=${{ github.event.inputs.mode }}
        else
          # 定时任务时根据北京时间判断模式
          if [ "$BEIJING_HOUR" -lt "12" ]; then
            echo "北京时间小于12点，执行上班卡"
            export MODE=morning
          else
            echo "北京时间大于等于12点，执行下班卡"
            export MODE=evening
          fi
        fi
        
        # 执行打卡
        python auto.py